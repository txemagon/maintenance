#!/bin/bash
# rcp-dir
# Oct, 2015. txema.gonz@gmail.com



VERSION=1.0

. /usr/share/nettenance/general.sh

display_usage () {
    cat <<EOF

    $NTT_CMD_NAME v$VERSION  -  Copies one dir from one host to another.

USAGE:
    $NTT_CMD_NAME [<options>] <src_uri> <target_uri>

    URIs are can use the following fields:

    [<protocol>://]<user>:<password>@host:port/path/

    port within scheme is used for the ssh connection.

OPTIONS:
    -p, --port:
          Port used to configure netcat and start copying.
          Default port is 8888.

    -h, --help
          Shows usage.

    -V, --version
          Displays program version.

EXAMPLES:

    $NTT_CMD_NAME root@172.17.1.20/var/www/mempleo.es root@172.17.1.200/var/www
    $NTT_CMD_NAME ./src root:my_pass@172.17.1.200/var/www

EOF
}


# read the options
TEMP=`getopt -o hVp: --long help,version,port: -n $NTT_CMD_NAME -- "$@"`

eval set -- "$TEMP"

# extract options and their arguments into variables.

while true ; do
    case "$1" in
        -h|--help) display_usage; exit 0 ;;
        -V|--version) display_version; exit 0;;
        -p|--port) case "$2" in
            "") shift 2 ;;
            *) port=$2 ; shift 2 ;;
        esac ;;
        --) shift ; break ;;
        *) echo "Internal error!" >&2; exit 1 ;;
    esac
done

ensure_args 2 $#

declare -A src_uri
declare -A target_uri


while read -r line || [[ -n "$line" ]]; do
    eval $line
done < <(parse-scheme $1 | \
         hash_load "src_uri")


while read -r line || [[ -n "$line" ]]; do
    eval $line
done < <(parse-scheme $2 | \
         hash_load "target_uri")


## Main Program

my_ip=$(my_ip_for ${target_uri[host]})

echo -e "$(load_script "$(look_for setup_rcp-dir_src.sh MNVR)" "${src_uri[path]}" $my_ip)" > .sourcehost_script
echo -e "$(load_script "$(look_for setup_rcp_target.sh MNVR)"  "${target_uri[path]}")" > .targethost_script

echo "$( ssh_command -t "$(declare -p src_uri )" )   \"\$(< .sourcehost_script)\"" > .srccmd_tab
echo "$( ssh_command -t "$(declare -p target_uri )") \"\$(< .targethost_script)\"" > .target_tab

gnome-terminal --tab -e "bash .srccmd_tab"  --tab -e "bash .target_tab"


# Garbage will remain.
#rm .srccmd_tab
#rm .target_tab
#rm .sourcehost_script
#rm .targethost_script


